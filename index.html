<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Churros take South Korea</title>
  <meta name="description" content="A lightweight, shareable trip-planning hub for Churros take South Korea." />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
  <style>
    :root {
      --bg: #f7f8fb;
      --panel: #ffffff;
      --panel2: #fbfbfe;
      --text: #101326;
      --muted: #5a6178;
      --border: rgba(16,19,38,.10);
      --shadow: 0 12px 30px rgba(16,19,38,.08);
      --shadow2: 0 10px 18px rgba(16,19,38,.07);
      --accent: #6E50FF;
      --accent2: #1FD4B5;
      --danger: #ff4d6d;
      --warn: #ffb703;
      --ok: #22c55e;
      --radius: 18px;
      --radius2: 12px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--text);
      background:
        radial-gradient(900px 420px at 20% -10%, rgba(110,80,255,.18), transparent 60%),
        radial-gradient(850px 520px at 100% 10%, rgba(31,212,181,.14), transparent 55%),
        radial-gradient(900px 480px at 40% 110%, rgba(255,183,3,.12), transparent 50%),
        var(--bg);
    }
    a { color: inherit; }
    .app {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 18px;
      max-width: 1400px;
      margin: 0 auto;
      padding: 18px;
    }
    @media (max-width: 980px) {
      .app { grid-template-columns: 1fr; }
    }
    .side {
      position: sticky;
      top: 18px;
      height: calc(100vh - 36px);
      background: rgba(255,255,255,.76);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    @media (max-width: 980px) {
      .side { position: relative; height: auto; }
    }
    .brand {
      padding: 18px 18px 10px 18px;
      display: flex;
      gap: 12px;
      align-items: center;
      border-bottom: 1px solid var(--border);
    }
    .logo {
      width: 42px; height: 42px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(110,80,255,1), rgba(31,212,181,1));
      box-shadow: 0 10px 20px rgba(110,80,255,.22);
      display: grid;
      place-items: center;
      color: white;
      font-weight: 800;
      letter-spacing: .5px;
    }
    .brand h1 {
      font-size: 16px;
      margin: 0;
      line-height: 1.15;
    }
    .brand .sub {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }
    .nav {
      padding: 10px;
      display: grid;
      gap: 8px;
    }
    .nav button {
      width: 100%;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.7);
      border-radius: 14px;
      padding: 10px 12px;
      cursor: pointer;
      text-align: left;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
    }
    .nav button:hover { transform: translateY(-1px); background: rgba(255,255,255,.95); }
    .nav button.active {
      border-color: rgba(110,80,255,.35);
      background: linear-gradient(180deg, rgba(110,80,255,.12), rgba(255,255,255,.85));
    }
    .nav .left {
      display: flex; gap: 10px; align-items: center;
      font-weight: 650;
    }
    .pill {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.8);
      color: var(--muted);
    }
    .footer {
      margin-top: auto;
      padding: 12px 14px;
      border-top: 1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
    }
    .main {
      min-height: calc(100vh - 36px);
    }
    .topbar {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .topbar .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.76);
      border-radius: 999px;
      box-shadow: var(--shadow2);
    }
    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, .8fr);
      gap: 18px;
    }
    @media (max-width: 1100px) {
      .grid { grid-template-columns: 1fr; }
    }
    .card {
      border: 1px solid var(--border);
      background: rgba(255,255,255,.86);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card .hd {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .card .hd h2 {
      margin: 0;
      font-size: 14px;
      letter-spacing: .2px;
    }
    .card .bd {
      padding: 14px 16px 16px 16px;
    }
    .kpi {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    @media (max-width: 560px) {
      .kpi { grid-template-columns: 1fr; }
    }
    .kpi .box {
      padding: 12px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.86), rgba(247,248,251,.65));
    }
    .kpi .label { font-size: 12px; color: var(--muted); }
    .kpi .value { font-size: 18px; font-weight: 780; margin-top: 6px; }
    .btn {
      border: 1px solid rgba(110,80,255,.35);
      background: rgba(110,80,255,.10);
      color: var(--text);
      border-radius: 14px;
      padding: 9px 12px;
      cursor: pointer;
      font-weight: 650;
      transition: transform .08s ease, background .12s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      user-select: none;
    }
    .btn:hover { transform: translateY(-1px); background: rgba(110,80,255,.14); }
    .btn.primary {
      background: linear-gradient(135deg, rgba(110,80,255,1), rgba(31,212,181,1));
      color: white;
      border-color: transparent;
      box-shadow: 0 12px 20px rgba(110,80,255,.22);
    }
    .btn.ghost {
      border: 1px solid var(--border);
      background: rgba(255,255,255,.7);
      color: var(--text);
    }
    .btn.danger {
      border-color: rgba(255,77,109,.35);
      background: rgba(255,77,109,.10);
    }
    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .list {
      display: grid;
      gap: 10px;
    }
    .todo {
      display: grid;
      grid-template-columns: 28px 1fr auto;
      gap: 10px;
      align-items: center;
      padding: 10px 10px;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: rgba(255,255,255,.78);
    }
    .todo .title { font-weight: 650; }
    .todo .meta { font-size: 12px; color: var(--muted); margin-top: 4px; }
    input[type="checkbox"] {
      width: 18px; height: 18px;
      accent-color: var(--accent);
    }
    .table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow: hidden;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: rgba(255,255,255,.82);
    }
    .table th, .table td {
      padding: 10px 10px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      vertical-align: top;
    }
    .table th {
      text-align: left;
      font-size: 12px;
      color: var(--muted);
      background: rgba(247,248,251,.7);
    }
    .table tr:last-child td { border-bottom: none; }
    .input, select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,.85);
      outline: none;
    }
    .input:focus, select:focus { border-color: rgba(110,80,255,.42); box-shadow: 0 0 0 4px rgba(110,80,255,.10); }
    .split {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 12px;
    }
    @media (max-width: 860px) {
      .split { grid-template-columns: 1fr; }
    }
    .tag {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      padding: 3px 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      background: rgba(255,255,255,.82);
      margin-right: 6px;
      margin-top: 6px;
    }
    .cards {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 14px;
    }
    @media (max-width: 780px) {
      .cards { grid-template-columns: 1fr; }
    }
    .place {
      padding: 12px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.84);
      display: grid;
      gap: 8px;
    }
    .place .name { font-weight: 800; }
    .place .mini { font-size: 12px; color: var(--muted); }
    .place .actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .muted { color: var(--muted); }
    .mono { font-variant-numeric: tabular-nums; }
    .modal {
      position: fixed; inset: 0;
      display: none;
      place-items: center;
      padding: 18px;
      background: rgba(16,19,38,.45);
      backdrop-filter: blur(6px);
      z-index: 50;
    }
    .modal.open { display: grid; }
    .modal .sheet {
      width: min(760px, 100%);
      border: 1px solid rgba(255,255,255,.22);
      border-radius: 22px;
      background: rgba(255,255,255,.92);
      box-shadow: 0 30px 70px rgba(16,19,38,.25);
      overflow: hidden;
    }
    .modal .sheet .hd {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .modal .sheet .bd { padding: 14px 16px 18px 16px; }
    .x {
      width: 38px; height: 38px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.85);
      cursor: pointer;
      display: grid; place-items: center;
      font-weight: 900;
    }
    .itGrid {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 18px;
    }
    @media (max-width: 980px) {
      .itGrid { grid-template-columns: 1fr; }
    }
    .dayList {
      display: grid;
      gap: 8px;
    }
    .dayBtn {
      border: 1px solid var(--border);
      background: rgba(255,255,255,.78);
      border-radius: 16px;
      padding: 10px 12px;
      cursor: pointer;
      display: grid;
      gap: 6px;
      transition: transform .08s ease, background .12s ease;
    }
    .dayBtn:hover { transform: translateY(-1px); background: rgba(255,255,255,.95); }
    .dayBtn.active {
      border-color: rgba(110,80,255,.35);
      background: linear-gradient(180deg, rgba(110,80,255,.12), rgba(255,255,255,.9));
    }
    .dayBtn .d1 { font-weight: 780; }
    .dayBtn .d2 { font-size: 12px; color: var(--muted); }
    .sectionBox {
      border: 1px solid var(--border);
      border-radius: 18px;
      background: rgba(255,255,255,.84);
      overflow: hidden;
    }
    .sectionBox .shd {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      background: rgba(247,248,251,.6);
    }
    .sectionBox .sbd {
      padding: 12px;
      display: grid;
      gap: 8px;
    }
    .note {
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.8);
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: flex-start;
    }
    .note .t { font-size: 13px; line-height: 1.3; }
    .note .small { font-size: 12px; color: var(--muted); margin-top: 6px; }
    .note .actions { display: flex; gap: 8px; }
    .miniBtn {
      border: 1px solid var(--border);
      background: rgba(255,255,255,.85);
      border-radius: 12px;
      padding: 8px 10px;
      cursor: pointer;
      font-weight: 650;
      font-size: 12px;
    }
    .miniBtn:hover { background: rgba(255,255,255,.97); }
    .bar {
      height: 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(247,248,251,.6);
      overflow: hidden;
    }
    .bar > div {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(110,80,255,1), rgba(31,212,181,1));
      border-radius: 999px;
      transition: width .25s ease;
    }
    .hint {
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
      line-height: 1.35;
    }
    .kbd {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.8);
    }
  
    /* Per-expense participants chips */
    .chips { display:flex; flex-wrap:wrap; gap:8px; }
    .chipBtn{
      border:1px solid var(--border);
      background: rgba(247,248,251,.6);
      border-radius:999px;
      padding:8px 10px;
      font-weight:700;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, border-color .2s ease, background .2s ease;
    }
    .chipBtn:hover{ border-color:#cbd5e1; }
    .chipBtn:active{ transform: translateY(1px); }
    .chipBtn.on{
      background: linear-gradient(135deg, rgba(79,70,229,.16), rgba(6,182,212,.14));
      border-color: rgba(79,70,229,.35);
    }
    .chipBtn.off{ opacity:.55; }

    /* Embedded maps */
    .mapBox{
      border: 1px solid var(--border);
      background: rgba(247,248,251,.5);
      border-radius: 18px;
      padding: 12px;
    }
    .mapFrame{
      width:100%;
      height: 360px;
      border: 0;
      border-radius: 14px;
      background: white;
    }
    @media (max-width: 1100px){
      .mapFrame{ height: 320px; }
    }

</style>
</head>
<body>
  <script>
    window.__INITIAL_DATA__ = {"meta":{"title":"Churros take South Korea","version":1,"created":"2026-01-30T05:21:36.404133"},"trip":{"siteTitle":"Churros take South Korea","destination":"South Korea","startDate":"","endDate":"","travellers":["Henry","Cordelia","Jesse","Oliver","Mikaela","Amy"]},"todos":[{"id":"t1","title":"Book flights","owner":"","due":"","done":false},{"id":"t2","title":"Choose neighbourhood for accommodation","owner":"","due":"","done":false},{"id":"t3","title":"Sort SIM/eSIM plan","owner":"","due":"","done":false}],"budget":{"categories":[{"id":"c1","name":"Flights","estimated":0},{"id":"c2","name":"Stay","estimated":0},{"id":"c3","name":"Transport","estimated":0},{"id":"c4","name":"Food","estimated":0},{"id":"c5","name":"Activities","estimated":0},{"id":"c6","name":"Shopping","estimated":0}],"expenses":[]},"itinerary":{"startDate":"","endDate":"","days":[],"sections":["Morning","Afternoon","Evening"],"items":{},"attractions":[],"packing":{"Henry":[],"Cordelia":[],"Jesse":[],"Oliver":[],"Mikaela":[],"Amy":[]},"polls":[],"links":[]},"attractions":[],"polls":[],"links":[],"packing":{},"__ui":{}};
  </script>

  <div class="app" id="app">
    <aside class="side">
      <div class="brand">
        <div class="logo">üç©</div>
        <div>
          <h1 id="brandTitle">Churros take South Korea</h1>
          <div class="sub" id="brandSub">Or North Korea</div>
        </div>
      </div>

      <div class="nav" id="nav"></div>

      <div class="footer">
        <div><span class="pill" id="saveStatus">Saved</span></div>
        <div class="muted">Local-first ‚Ä¢ Export to share</div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="chip">
          <strong id="tripLine">South Korea</strong>
          <span class="muted" id="dateLine"></span>
        </div>
        <div class="row">
          <button class="btn ghost" id="btnExport">Export</button>
          <button class="btn ghost" id="btnImport">Import</button>
          <button class="btn primary" id="btnQuickAdd">Quick add</button>
        </div>
      </div>

      <div id="view"></div>
    </main>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="sheet">
      <div class="hd">
        <div>
          <div style="font-weight:800" id="modalTitle">Quick add</div>
          <div class="muted" style="font-size:12px" id="modalSub">Add something to the plan</div>
        </div>
        <button class="x" id="modalClose">‚úï</button>
      </div>
      <div class="bd" id="modalBody"></div>
    </div>
  </div>

  <input type="file" id="fileInput" accept="application/json" style="display:none" />

  <script>
  dayjs.extend(dayjs_plugin_relativeTime);

  // ---------------------------
  // State + persistence
  // ---------------------------
  const STORAGE_KEY = "churros_take_south_korea__v1";
  const savePill = document.getElementById("saveStatus");

  function deepClone(x) {
    return JSON.parse(JSON.stringify(x));
  }

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return deepClone(window.__INITIAL_DATA__);
      return Object.assign(deepClone(window.__INITIAL_DATA__), JSON.parse(raw));
    } catch (e) {
      console.warn("Load failed, using initial data", e);
      return deepClone(window.__INITIAL_DATA__);
    }
  }

  let state = loadState();

  let saveTimer = null;
  function markDirty() {
    savePill.textContent = "Saving‚Ä¶";
    savePill.style.borderColor = "rgba(255,183,3,.35)";
    savePill.style.background = "rgba(255,183,3,.10)";
    clearTimeout(saveTimer);
    saveTimer = setTimeout(() => {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      savePill.textContent = "Saved";
      savePill.style.borderColor = "rgba(34,197,94,.30)";
      savePill.style.background = "rgba(34,197,94,.10)";
    }, 180);
  }

  // ---------------------------
  // Helpers
  // ---------------------------
  const fmtAUD = (n) => new Intl.NumberFormat(undefined, { style:"currency", currency:"AUD" }).format(Number(n || 0));
  const fmt = (n) => new Intl.NumberFormat(undefined, { maximumFractionDigits: 0 }).format(Number(n || 0));
  const fmt2 = (n) => new Intl.NumberFormat(undefined, { maximumFractionDigits: 2 }).format(Number(n || 0));

  function esc(s) {
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;");
  }

  function uid() {
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function ensureItineraryShape() {
    if (!state.itinerary.items) state.itinerary.items = {};
    for (const d of state.itinerary.days) {
      if (!state.itinerary.items[d]) state.itinerary.items[d] = {};
      for (const sec of state.itinerary.sections) {
        if (!state.itinerary.items[d][sec]) state.itinerary.items[d][sec] = [];
      }
    }
  }
  ensureItineraryShape();

  function tripRangeLabel() {
    const s = dayjs(state.trip.startDate).format("D MMM YYYY");
    const e = dayjs(state.trip.endDate).format("D MMM YYYY");
    return `${s} ‚Üí ${e}`;
  }

  function countdownLabel() {
    const now = dayjs();
    const start = dayjs(state.trip.startDate);
    if (now.isAfter(start, "day")) {
      return "Trip is in progress / past";
    }
    const days = start.startOf("day").diff(now.startOf("day"), "day");
    return `${days} day${days===1?"":"s"} to go`;
  }

  function totalBudgetActual() {
    return state.budget.categories.reduce((a,c)=>a+Number(c.actual||0),0);
  }
  function totalBudgetEstimated() {
    return state.budget.categories.reduce((a,c)=>a+Number(c.estimated||0),0);
  }

  function travellers() {
    return state.trip.travellers || [];
  }

  // Split balances (positive = owed to person)
  function computeBalances() {
    const people = travellers();
    const balances = Object.fromEntries(people.map(p=>[p,0]));
    for (const ex of state.budget.expenses) {
      const aud = Number(ex.aud || 0);
      if (!aud || aud === 0) continue;
      const paidBy = ex.paidBy || "";
      const parts = (Array.isArray(ex.participants) && ex.participants.length)
        ? ex.participants
        : people;
      const splitN = parts.length || 1;
      const share = aud / splitN;
      for (const p of parts) if (balances[p] != null) balances[p] -= share;
      if (paidBy && balances[paidBy] != null) balances[paidBy] += aud;
    }
    // Round to cents for stability
    for (const p of Object.keys(balances)) balances[p] = Math.round(balances[p]*100)/100;
    return balances;
  }

  // ---------------------------
  // Modal
  // ---------------------------
  const modal = document.getElementById("modal");
  const modalTitle = document.getElementById("modalTitle");
  const modalSub = document.getElementById("modalSub");
  const modalBody = document.getElementById("modalBody");
  document.getElementById("modalClose").onclick = () => closeModal();
  modal.addEventListener("click", (e)=>{ if (e.target === modal) closeModal(); });

  function openModal({title, sub, bodyHtml}) {
    modalTitle.textContent = title;
    modalSub.textContent = sub || "";
    modalBody.innerHTML = bodyHtml;
    modal.classList.add("open");
  }
  function closeModal() {
    modal.classList.remove("open");
    modalBody.innerHTML = "";
  }

  // ---------------------------
  // Navigation + Routing
  // ---------------------------
  const PAGES = [
    { id: "overview", label: "Overview", pill: () => countdownLabel() },
    { id: "itinerary", label: "Itinerary", pill: () => `${state.itinerary.days.length} days` },
    { id: "budget", label: "Budget", pill: () => fmtAUD(totalBudgetActual()) },
    { id: "attractions", label: "Attractions", pill: () => `${state.attractions.length} spots` },
    { id: "packing", label: "Packing", pill: () => `${travellers().length} people` },
    { id: "ideas", label: "Polls & Ideas", pill: () => `${state.polls.length} polls` },
    { id: "settings", label: "Settings", pill: () => "Import/Export" },
  ];

  const navEl = document.getElementById("nav");
  const viewEl = document.getElementById("view");

  function setHash(id) {
    location.hash = "#" + id;
  }

  function currentPage() {
    const h = (location.hash || "#overview").replace("#","");
    return PAGES.find(p=>p.id===h) ? h : "overview";
  }

  function renderNav() {
    navEl.innerHTML = PAGES.map(p=>{
      const active = (p.id === currentPage()) ? "active" : "";
      return `
        <button class="${active}" data-page="${p.id}">
          <div class="left">
            <span>${esc(p.label)}</span>
          </div>
          <span class="pill">${esc(p.pill())}</span>
        </button>
      `;
    }).join("");

    for (const btn of navEl.querySelectorAll("button")) {
      btn.onclick = () => setHash(btn.dataset.page);
    }
  }

  // ---------------------------
  // Render: Overview
  // ---------------------------
  function renderOverview() {
    const people = travellers();
    const start = dayjs(state.trip.startDate);
    const end = dayjs(state.trip.endDate);
    const durDays = end.diff(start, "day") + 1;
    const budgetA = totalBudgetActual();
    const budgetE = totalBudgetEstimated();
    const perPerson = people.length ? budgetA / people.length : 0;

    const done = state.todos.filter(t=>t.done).length;
    const total = state.todos.length;
    const pct = total ? Math.round(done/total*100) : 0;

    const recentExpenses = [...state.budget.expenses]
      .filter(e => Number(e.aud||0) > 0)
      .slice(0,5);

    return `
      <div class="grid">
        <section class="card">
          <div class="hd">
            <h2>Trip heartbeat</h2>
            <div class="row">
              <button class="btn ghost" id="btnEditTrip">Edit trip</button>
              <button class="btn primary" id="btnAddTodo">Add task</button>
            </div>
          </div>
          <div class="bd">
            <div class="kpi">
              <div class="box">
                <div class="label">Countdown</div>
                <div class="value mono">${esc(countdownLabel())}</div>
              </div>
              <div class="box">
                <div class="label">Dates</div>
                <div class="value mono">${esc(tripRangeLabel())}</div>
              </div>
              <div class="box">
                <div class="label">Crew</div>
                <div class="value mono">${people.length} people</div>
              </div>
            </div>

            <div style="height:14px"></div>

            <div class="split">
              <div>
                <div class="muted" style="font-size:12px; font-weight:650;">To-do progress</div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
                  <div><strong>${done}</strong> / ${total} tasks done</div>
                  <div class="pill">${pct}%</div>
                </div>
                <div class="bar" style="margin-top:8px"><div style="width:${pct}%"></div></div>

                <div class="hint">
                </div>
              </div>

              <div>
                <div class="muted" style="font-size:12px; font-weight:650;">Budget snapshot</div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
                  <div><strong>${fmtAUD(budgetA)}</strong> spent</div>
                  <div class="pill">Est. ${fmtAUD(budgetE)}</div>
                </div>
                <div class="hint">
                </div>
              </div>
            </div>

            <div style="height:14px"></div>

            <div class="row">
              ${
                people.map(p=>`<span class="tag">üë§ ${esc(p)}</span>`).join("")
              }
            </div>
          </div>
        </section>

        <section class="card">
          <div class="hd">
            <h2>Today‚Äôs focus</h2>
            <button class="btn ghost" id="btnQuickExpense">Log expense</button>
          </div>
          <div class="bd">
            <div class="list" id="todoList">
              ${
                state.todos.map((t,idx)=>`
                  <div class="todo">
                    <input type="checkbox" data-i="${idx}" ${t.done ? "checked":""} />
                    <div>
                      <div class="title">${esc(t.title)}</div>
                      <div class="meta">Owner: <strong>${esc(t.owner||"‚Äî")}</strong> ‚Ä¢ Due: <span class="mono">${esc(t.due||"‚Äî")}</span></div>
                    </div>
                    <button class="miniBtn" data-del="${idx}">Delete</button>
                  </div>
                `).join("")
              }
            </div>

            <div style="height:14px"></div>

            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:8px;">Recent expenses</div>
            <table class="table">
              <thead><tr><th>What</th><th>Paid by</th><th style="text-align:right;">AUD</th></tr></thead>
              <tbody>
                ${
                  recentExpenses.length ? recentExpenses.map(e=>`
                    <tr>
                      <td><strong>${esc(e.category)}</strong><div class="muted" style="font-size:12px">${esc(e.description||"")}</div></td>
                      <td>${esc(e.paidBy||"‚Äî")}</td>
                      <td style="text-align:right;" class="mono">${fmtAUD(e.aud)}</td>
                    </tr>
                  `).join("") : `<tr><td colspan="3" class="muted">No expenses yet. Flex on 'em by logging the first ‚Ç©.</td></tr>`
                }
              </tbody>
            </table>
          </div>
        </section>
      </div>
    `;
  }

  function bindOverview() {
    // Todo toggles
    document.querySelectorAll('#todoList input[type="checkbox"]').forEach(cb=>{
      cb.onchange = () => {
        const i = Number(cb.dataset.i);
        state.todos[i].done = cb.checked;
        markDirty();
        rerender();
      };
    });
    document.querySelectorAll('#todoList [data-del]').forEach(btn=>{
      btn.onclick = () => {
        const i = Number(btn.dataset.del);
        state.todos.splice(i,1);
        markDirty();
        rerender();
      };
    });

    document.getElementById("btnAddTodo").onclick = () => openTodoModal();
    document.getElementById("btnEditTrip").onclick = () => openTripModal();
    document.getElementById("btnQuickExpense").onclick = () => openExpenseModal({goToBudget:false});
  }

  // ---------------------------
  // Render: Itinerary
  // ---------------------------
  let selectedDay = state.itinerary.days[0] || dayjs().format("YYYY-MM-DD");

  function dayLabel(d) {
    const dd = dayjs(d);
    return `${dd.format("ddd D MMM")}`;
  }

  function renderItinerary() {
    ensureItineraryShape();
    if (!state.itinerary.days.includes(selectedDay)) {
      selectedDay = state.itinerary.days[0] || selectedDay;
    }
    const dayButtons = state.itinerary.days.map(d=>{
      const active = (d===selectedDay) ? "active" : "";
      const entries = Object.values(state.itinerary.items[d]||{}).reduce((a,arr)=>a+(arr?.length||0),0);
      return `
        <div class="dayBtn ${active}" data-day="${d}">
          <div class="d1">${esc(dayLabel(d))}</div>
          <div class="d2">${entries} item${entries===1?"":"s"}</div>
        </div>
      `;
    }).join("");

    const secHtml = state.itinerary.sections.map(sec=>{
      const items = state.itinerary.items[selectedDay][sec] || [];
      return `
        <div class="sectionBox">
          <div class="shd">
            <strong>${esc(sec)}</strong>
            <button class="miniBtn" data-add-it="${esc(sec)}">Add</button>
          </div>
          <div class="sbd">
            ${
              items.length ? items.map((it,idx)=>`
                <div class="note">
                  <div>
                    <div class="t">${esc(it.text)}</div>
                    <div class="small">${esc(it.owner ? "üë§ " + it.owner : " ")}${esc(it.time ? " ‚Ä¢ ‚è∞ " + it.time : "")}${esc(it.place ? " ‚Ä¢ üìç " + it.place : "")}</div>
                  </div>
                  <div class="actions">
                    <button class="miniBtn" data-edit-it="${sec}" data-idx="${idx}">Edit</button>
                    <button class="miniBtn" data-del-it="${sec}" data-idx="${idx}">Del</button>
                  </div>
                </div>
              `).join("") : `<div class="muted">Nothing here yet. Tap <span class="kbd">Add</span> to start building the day.</div>`
            }
          </div>
        </div>
      `;
    }).join("");


    const mapItems = [];
    for (const sec of state.itinerary.sections) {
      const items = (state.itinerary.items[selectedDay] && state.itinerary.items[selectedDay][sec]) ? state.itinerary.items[selectedDay][sec] : [];
      for (const it of items) {
        const place = (it.place||"").trim();
        if (!place) continue;
        mapItems.push({ label: `${it.text}${place?` ‚Ä¢ ${place}`:""}`, query: place });
      }
    }
    const itMapIdx = Math.min(Number(state.__ui?.itMapIdx ?? 0), Math.max(mapItems.length-1, 0));
    const itMapQuery = mapItems[itMapIdx]?.query || (state.trip.destination || "South Korea");
    const itMapSrc = `https://www.google.com/maps?q=${encodeURIComponent(itMapQuery)}&output=embed`;


    return `
      <div class="itGrid">
        <section class="card">
          <div class="hd">
            <h2>Days</h2>
            <div class="row">
              <button class="btn ghost" id="btnAddDay">Add day</button>
              <button class="btn primary" id="btnAddBig">Add item</button>
            </div>
          </div>
          <div class="bd">
            <div class="dayList" id="dayList">${dayButtons}</div>
            <div class="hint">Pro move: keep <strong>Main events</strong> short, put details in <strong>Notes</strong>.</div>
          </div>
        </section>

        <section class="card">
          <div class="hd">
            <h2>Plan for <span class="mono">${esc(selectedDay)}</span></h2>
            <div class="row">
              <button class="btn ghost" id="btnCopyDay">Copy from previous</button>
              <button class="btn ghost" id="btnClearDay">Clear day</button>
            </div>
          </div>
          <div class="bd" style="display:grid; gap:12px;">
            ${secHtml}
            <div class="mapBox">
              <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Map for this day</div>
              <select id="itMapPick" style="margin-bottom:10px;">
                ${
                  mapItems.length
                    ? mapItems.map((m,i)=>`<option value="${i}" ${i===itMapIdx?"selected":""}>${esc(m.label)}</option>`).join("")
                    : `<option value="0">Add itinerary items with a üìç place to show them here</option>`
                }
              </select>
              <iframe class="mapFrame" id="itMapFrame" loading="lazy" referrerpolicy="no-referrer-when-downgrade" src="${itMapSrc}"></iframe>
            </div>
          </div>
        </section>
      </div>
    `;
  }

  function bindItinerary() {
    document.querySelectorAll("#dayList .dayBtn").forEach(el=>{
      el.onclick = () => {
        selectedDay = el.dataset.day;
        rerender();
      };
    });

    document.getElementById("btnAddBig").onclick = () => openItineraryItemModal({day:selectedDay});
    document.getElementById("btnAddDay").onclick = () => openAddDayModal();

    // Map for itinerary day
    const itPick = document.getElementById("itMapPick");
    const itFrame = document.getElementById("itMapFrame");
    if (itPick && itFrame) {
      itPick.onchange = () => {
        state.__ui.itMapIdx = Number(itPick.value || 0);
        const label = itPick.options[itPick.selectedIndex]?.textContent || (state.trip.destination || "South Korea");
        itFrame.src = `https://www.google.com/maps?q=${encodeURIComponent(label)}&output=embed`;
        markDirty();
      };
    }

    document.querySelectorAll("[data-add-it]").forEach(btn=>{
      btn.onclick = () => openItineraryItemModal({day:selectedDay, section: btn.dataset.addIt});
    });
    document.querySelectorAll("[data-del-it]").forEach(btn=>{
      btn.onclick = () => {
        const sec = btn.dataset.delIt;
        const idx = Number(btn.dataset.idx);
        state.itinerary.items[selectedDay][sec].splice(idx,1);
        markDirty(); rerender();
      };
    });
    document.querySelectorAll("[data-edit-it]").forEach(btn=>{
      btn.onclick = () => {
        const sec = btn.dataset.editIt;
        const idx = Number(btn.dataset.idx);
        openItineraryItemModal({day:selectedDay, section: sec, idx});
      };
    });

    document.getElementById("btnClearDay").onclick = () => {
      if (!confirm("Clear all sections for this day?")) return;
      for (const sec of state.itinerary.sections) state.itinerary.items[selectedDay][sec] = [];
      markDirty(); rerender();
    };

    document.getElementById("btnCopyDay").onclick = () => {
      const i = state.itinerary.days.indexOf(selectedDay);
      if (i <= 0) return alert("No previous day to copy from.");
      const prev = state.itinerary.days[i-1];
      state.itinerary.items[selectedDay] = deepClone(state.itinerary.items[prev]);
      markDirty(); rerender();
    };
  }

  // ---------------------------
  // Render: Budget
  // ---------------------------
  let budgetChart = null;

  function renderBudget() {
    const people = travellers();
    const balances = computeBalances();
    const exCount = state.budget.expenses.length;

    return `
      <div class="grid">
        <section class="card">
          <div class="hd">
            <h2>Budget overview</h2>
            <div class="row">
              <button class="btn ghost" id="btnAddCat">Add category</button>
              <button class="btn primary" id="btnAddExpense">Add expense</button>
            </div>
          </div>
          <div class="bd">
            <div class="split">
              <div>
                <canvas id="budgetChart" height="160"></canvas>
                <div class="hint"></div>
              </div>
              <div>
                <div class="kpi">
                  <div class="box">
                    <div class="label">Estimated total</div>
                    <div class="value mono">${fmtAUD(totalBudgetEstimated())}</div>
                  </div>
                  <div class="box">
                    <div class="label">Actual total</div>
                    <div class="value mono">${fmtAUD(totalBudgetActual())}</div>
                  </div>
                  <div class="box">
                    <div class="label">Per person (even split)</div>
                    <div class="value mono">${fmtAUD(people.length ? totalBudgetActual()/people.length : 0)}</div>
                  </div>
                </div>

                <div style="height:12px"></div>

                <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:8px;">Who‚Äôs up / down</div>
                <table class="table">
                  <thead><tr><th>Person</th><th style="text-align:right;">Balance</th></tr></thead>
                  <tbody>
                    ${
                      people.map(p=>{
                        const b = balances[p] || 0;
                        const sign = b >= 0 ? "+" : "‚àí";
                        return `
                          <tr>
                            <td><strong>${esc(p)}</strong></td>
                            <td style="text-align:right;" class="mono">${sign}${fmtAUD(Math.abs(b))}</td>
                          </tr>
                        `;
                      }).join("")
                    }
                  </tbody>
                </table>

                <div class="hint">
                  Balance = how much the group owes that person (positive), or how much they owe the group (negative).
                </div>
              </div>
            </div>

            <div style="height:14px"></div>

            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:8px;">Categories</div>
            <table class="table" id="catTable">
              <thead><tr>
                <th>Category</th>
                <th style="text-align:right;">Estimated (AUD)</th>
                <th style="text-align:right;">Actual (AUD)</th>
                <th style="text-align:right;">Per person</th>
                <th></th>
              </tr></thead>
              <tbody>
                ${
                  state.budget.categories.map((c,idx)=>{
                    const pp = people.length ? Number(c.actual||0)/people.length : 0;
                    return `
                      <tr>
                        <td>
                          <strong>${esc(c.category)}</strong>
                        </td>
                        <td style="text-align:right;"><input class="input mono" data-cat-est="${idx}" value="${esc(fmt2(c.estimated))}" /></td>
                        <td style="text-align:right;"><input class="input mono" data-cat-act="${idx}" value="${esc(fmt2(c.actual))}" /></td>
                        <td style="text-align:right;" class="mono">${fmtAUD(pp)}</td>
                        <td style="text-align:right;"><button class="miniBtn" data-del-cat="${idx}">Del</button></td>
                      </tr>
                    `;
                  }).join("")
                }
              </tbody>
            </table>

            <div style="height:14px"></div>

            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:8px;">Expenses tracker</div>
            <table class="table" id="expTable">
              <thead><tr>
                <th>Category</th>
                <th>Description</th>
                <th>Paid by</th>
                <th style="text-align:right;">AUD</th>
                <th>Paid?</th>
                <th></th>
              </tr></thead>
              <tbody>
                ${
                  state.budget.expenses.slice(0,50).map((e,idx)=>`
                    <tr>
                      <td>${esc(e.category)}</td>
                      <td>${esc(e.description||"")}</td>
                      <td>${esc(e.paidBy||"‚Äî")}</td>
                      <td style="text-align:right;" class="mono">${fmtAUD(e.aud)}</td>
                      <td>${e.paid ? "‚úÖ" : "‚Äî"}</td>
                      <td style="text-align:right;"><button class="miniBtn" data-del-exp="${idx}">Del</button></td>
                    </tr>
                  `).join("")
                }
              </tbody>
            </table>
            <div class="hint">Showing first 50 rows. Use <span class="kbd">Add expense</span> to log more. Export to share updates.</div>
          </div>
        </section>

        <section class="card">
          <div class="hd">
            <h2>Settle up</h2>
            <button class="btn ghost" id="btnSuggestSettle">Suggest transfers</button>
          </div>
          <div class="bd">
            <div id="settleBox" class="muted">
              <strong>Suggest transfers
            </div>

            <div style="height:12px"></div>

            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:8px;">Tip</div>
            <div class="hint">
              ‚Ä¢ Keep descriptions short so it‚Äôs readable on mobile.
            </div>
          </div>
        </section>
      </div>
    `;
  }

  function bindBudget() {
    // category edits
    document.querySelectorAll("[data-cat-est]").forEach(inp=>{
      inp.onchange = () => {
        const i = Number(inp.dataset.catEst);
        state.budget.categories[i].estimated = Number(inp.value || 0);
        markDirty(); rerender();
      };
    });
    document.querySelectorAll("[data-cat-act]").forEach(inp=>{
      inp.onchange = () => {
        const i = Number(inp.dataset.catAct);
        state.budget.categories[i].actual = Number(inp.value || 0);
        markDirty(); rerender();
      };
    });
    document.querySelectorAll("[data-del-cat]").forEach(btn=>{
      btn.onclick = () => {
        const i = Number(btn.dataset.delCat);
        state.budget.categories.splice(i,1);
        markDirty(); rerender();
      };
    });
    document.querySelectorAll("[data-del-exp]").forEach(btn=>{
      btn.onclick = () => {
        const i = Number(btn.dataset.delExp);
        state.budget.expenses.splice(i,1);
        markDirty(); rerender();
      };
    });

    document.getElementById("btnAddExpense").onclick = () => openExpenseModal({goToBudget:true});
    document.getElementById("btnAddCat").onclick = () => openCategoryModal();
    document.getElementById("btnSuggestSettle").onclick = () => {
      const transfers = suggestTransfers();
      const box = document.getElementById("settleBox");
      if (!transfers.length) {
        box.innerHTML = "<strong>All square.</strong> Nobody owes anyone anything (within rounding).";
        return;
      }
      box.innerHTML = `
        <div class="list">
          ${
            transfers.map(t=>`
              <div class="todo" style="grid-template-columns: 1fr auto;">
                <div>
                  <div class="title">üí∏ ${esc(t.from)} ‚Üí ${esc(t.to)}</div>
                  <div class="meta mono">${fmtAUD(t.amount)}</div>
                </div>
                <button class="miniBtn" data-copy="${esc(`${t.from} pays ${t.to} ${fmt2(t.amount)} AUD`)}">Copy</button>
              </div>
            `).join("")
          }
        </div>
        <div class="hint">Copy/paste to your group chat. Rounds to cents.</div>
      `;
      box.querySelectorAll("[data-copy]").forEach(btn=>{
        btn.onclick = async () => {
          try {
            await navigator.clipboard.writeText(btn.dataset.copy);
            btn.textContent = "Copied!";
            setTimeout(()=>btn.textContent="Copy", 900);
          } catch(e) {
            alert("Copy failed (browser permissions).");
          }
        };
      });
    };

    // chart
    const ctx = document.getElementById("budgetChart");
    if (ctx) {
      const labels = state.budget.categories.map(c=>c.category);
      const data = state.budget.categories.map(c=>Number(c.actual||0));
      const filtered = labels.map((l,i)=>({l, v:data[i]})).filter(x=>x.v>0);
      const chartData = {
        labels: filtered.map(x=>x.l),
        datasets: [{ label: "Actual (AUD)", data: filtered.map(x=>x.v) }]
      };
      if (budgetChart) budgetChart.destroy();
      budgetChart = new Chart(ctx, {
        type: "doughnut",
        data: chartData,
        options: {
          plugins: {
            legend: { position: "bottom" },
            tooltip: {
              callbacks: {
                label: (c) => `${c.label}: ${fmtAUD(c.parsed)}`
              }
            }
          },
          cutout: "68%"
        }
      });
    }
  }

  // Greedy settlement algorithm
  function suggestTransfers() {
    const balances = computeBalances(); // + => owed to, - => owes
    const creditors = [];
    const debtors = [];
    for (const [p,b] of Object.entries(balances)) {
      const v = Math.round(b*100)/100;
      if (v > 0.01) creditors.push([p,v]);
      else if (v < -0.01) debtors.push([p,-v]);
    }
    creditors.sort((a,b)=>b[1]-a[1]);
    debtors.sort((a,b)=>b[1]-a[1]);
    const transfers = [];
    let i=0,j=0;
    while (i<debtors.length && j<creditors.length) {
      const [dp, dv] = debtors[i];
      const [cp, cv] = creditors[j];
      const amt = Math.min(dv, cv);
      transfers.push({from: dp, to: cp, amount: Math.round(amt*100)/100});
      debtors[i][1] = Math.round((dv-amt)*100)/100;
      creditors[j][1] = Math.round((cv-amt)*100)/100;
      if (debtors[i][1] <= 0.01) i++;
      if (creditors[j][1] <= 0.01) j++;
    }
    return transfers;
  }

  // ---------------------------
  // Render: Attractions
  // ---------------------------
  function renderAttractions() {
    const cities = [...new Set(state.attractions.map(a=>a.city).filter(Boolean))].sort();
    const cityOpts = ["All", ...cities];
    const q = state.__ui?.attrQ || "";
    const city = state.__ui?.attrCity || "All";
    const onlySaved = !!state.__ui?.attrSaved;

    const filtered = state.attractions.filter(a=>{
      const matchesQ = !q || (a.name||"").toLowerCase().includes(q.toLowerCase()) || (a.notes||"").toLowerCase().includes(q.toLowerCase());
      const matchesCity = city==="All" || (a.city||"")===city;
      const matchesSaved = !onlySaved || !!a.saved;
      return matchesQ && matchesCity && matchesSaved;
    });

    const mapIdx = Math.min(Number(state.__ui?.spotMapIdx ?? 0), Math.max(filtered.length-1, 0));
    const mapQuery = filtered[mapIdx] ? `${filtered[mapIdx].name} ${filtered[mapIdx].city||""}` : (state.trip.destination||"South Korea");
    const mapSrc = `https://www.google.com/maps?q=${encodeURIComponent(mapQuery)}&output=embed`;

    return `
      <section class="card">
        <div class="hd">
          <h2>Attractions & spots</h2>
          <div class="row">
            <button class="btn ghost" id="btnAddSpot">Add spot</button>
            <button class="btn primary" id="btnMakeMap">Open Google Maps search</button>
          </div>
        </div>
        <div class="bd">
          <div class="split" style="align-items:end">
            <div>
              <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Search</div>
              <input class="input" id="attrQ" placeholder="e.g. palace, tower, markets‚Ä¶" value="${esc(q)}" />
            </div>
            <div class="row" style="justify-content:flex-end;">
              <label class="muted" style="font-size:12px; font-weight:650;">City</label>
              <select id="attrCity" style="min-width:180px;">
                ${
                  cityOpts.map(o=>`<option ${o===city?"selected":""}>${esc(o)}</option>`).join("")
                }
              </select>
              <label class="row" style="gap:8px;">
                <input type="checkbox" id="attrSaved" ${onlySaved?"checked":""} />
                <span class="muted" style="font-size:12px; font-weight:650;">Saved only</span>
              </label>
            </div>
          </div>

          <div style="height:14px"></div>

          
          <div class="split" style="grid-template-columns:minmax(0,1.1fr) minmax(0,.9fr); align-items:start;">
            <div class="cards">
            ${
              filtered.length ? filtered.map((a,idx)=>{
                const mapsQ = encodeURIComponent(`${a.name} ${a.city||""}`);
                const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${mapsQ}`;
                return `
                  <div class="place">
                    <div class="row" style="justify-content:space-between; align-items:flex-start;">
                      <div>
                        <div class="name">${esc(a.name)}</div>
            <div class="mapBox">
              <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Map preview</div>
              <select id="spotMapPick" style="margin-bottom:10px;">
                ${
                  filtered.length
                    ? filtered.map((a,i)=>`<option value="${i}" ${i===mapIdx?"selected":""}>${esc(a.name)}${a.city?` ‚Ä¢ ${esc(a.city)}`:""}</option>`).join("")
                    : `<option value="0">No spots yet</option>`
                }
              </select>
              <iframe class="mapFrame" id="spotMapFrame" loading="lazy" referrerpolicy="no-referrer-when-downgrade" src="${mapSrc}"></iframe>
              <div class="hint" style="margin-top:10px">Tip: add a city or address in the spot notes for better results.</div>
            </div>
          </div>
    
                        <div class="mini">${esc([a.city, a.hours].filter(Boolean).join(" ‚Ä¢ "))}</div>
                        <div class="mini">${a.feeWon ? "‚Ç© " + fmt(a.feeWon) : ""}</div>
                        <div class="mini">${esc(a.notes||"")}</div>
                      </div>
                      <button class="miniBtn" data-toggle-save="${idx}">${a.saved ? "‚òÖ Saved" : "‚òÜ Save"}</button>
                    </div>
                    <div class="actions">
                      <a class="btn ghost" href="${mapsUrl}" target="_blank" rel="noreferrer">Maps</a>
                      <button class="btn ghost" data-add-to-it="${idx}">Add to itinerary</button>
                      <button class="btn danger" data-del-spot="${idx}">Delete</button>
                    </div>
                  </div>
                `;
              }).join("") : `<div class="muted">No matches. Add a spot or clear filters.</div>`
            }
          </div>
        </div>
      </section>
    `;
  }

  function bindAttractions() {
    state.__ui = state.__ui || {};
    const q = document.getElementById("attrQ");
    const c = document.getElementById("attrCity");
    const s = document.getElementById("attrSaved");
    q.oninput = () => { state.__ui.attrQ = q.value; markDirty(); rerender(false); };
    c.onchange = () => { state.__ui.attrCity = c.value; markDirty(); rerender(false); };
    s.onchange = () => { state.__ui.attrSaved = s.checked; markDirty(); rerender(false); };

    // Map preview (attractions)
    const pick = document.getElementById("spotMapPick");
    const frame = document.getElementById("spotMapFrame");
    if (pick && frame) {
      pick.onchange = () => {
        state.__ui.spotMapIdx = Number(pick.value || 0);
        const label = pick.options[pick.selectedIndex]?.textContent || (state.trip.destination || "South Korea");
        frame.src = `https://www.google.com/maps?q=${encodeURIComponent(label)}&output=embed`;
        markDirty();
      };
    }


    document.getElementById("btnAddSpot").onclick = () => openSpotModal();
    document.getElementById("btnMakeMap").onclick = () => {
      const query = encodeURIComponent(state.trip.destination);
      window.open(`https://www.google.com/maps/search/?api=1&query=${query}`, "_blank");
    };

    document.querySelectorAll("[data-toggle-save]").forEach(btn=>{
      btn.onclick = () => {
        const i = Number(btn.dataset.toggleSave);
        state.attractions[i].saved = !state.attractions[i].saved;
        markDirty(); rerender(false);
      };
    });
    document.querySelectorAll("[data-del-spot]").forEach(btn=>{
      btn.onclick = () => {
        const i = Number(btn.dataset.delSpot);
        if (!confirm("Delete this spot?")) return;
        state.attractions.splice(i,1);
        markDirty(); rerender();
      };
    });
    document.querySelectorAll("[data-add-to-it]").forEach(btn=>{
      btn.onclick = () => {
        const i = Number(btn.dataset.addToIt);
        const a = state.attractions[i];
        openItineraryItemModal({ day: selectedDay, section: "Main events", prefill: {
          text: a.name,
          place: a.city || "",
          time: "",
          owner: ""
        } });
      };
    });
  }

  // ---------------------------
  // Render: Packing
  // ---------------------------
  function progress(items) {
    const total = items.length || 0;
    const done = items.filter(x=>x.packed).length;
    return { total, done, pct: total ? Math.round(done/total*100) : 0 };
  }

  function renderPacking() {
    const people = travellers();
    return `
      <section class="card">
        <div class="hd">
          <h2>Packing</h2>
          <div class="row">
            <button class="btn ghost" id="btnAddPackItem">Add item</button>
            <button class="btn primary" id="btnPackAll">Mark selected person as packed</button>
          </div>
        </div>
        <div class="bd">
          <div class="split">
            <div>
              <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:8px;">People</div>
              <div class="dayList" id="packPeople">
                ${
                  people.map(p=>{
                    const pr = progress(state.packing[p] || []);
                    const active = (state.__ui?.packPerson || people[0]) === p ? "active" : "";
                    return `
                      <div class="dayBtn ${active}" data-pack-person="${esc(p)}">
                        <div class="d1">${esc(p)}</div>
                        <div class="d2">${pr.done} / ${pr.total} packed ‚Ä¢ ${pr.pct}%</div>
                      </div>
                    `;
                  }).join("")
                }
              </div>
              <div class="hint"></div>
            </div>

            <div>
              <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:8px;">Checklist</div>
              <div id="packList"></div>
            </div>
          </div>
        </div>
      </section>
    `;
  }

  function bindPacking() {
    state.__ui = state.__ui || {};
    const people = travellers();
    const current = state.__ui.packPerson || people[0] || "";
    function renderChecklist(person) {
      const items = state.packing[person] || [];
      const pr = progress(items);
      document.getElementById("packList").innerHTML = `
        <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:10px;">
          <div><strong>${esc(person)}</strong> <span class="pill">${pr.pct}%</span></div>
          <div class="mono muted">${pr.done} / ${pr.total}</div>
        </div>
        <div class="bar" style="margin-bottom:12px"><div style="width:${pr.pct}%"></div></div>
        <div class="list">
          ${
            items.map((it,idx)=>`
              <div class="todo">
                <input type="checkbox" data-pack="${esc(person)}" data-idx="${idx}" ${it.packed?"checked":""} />
                <div>
                  <div class="title">${esc(it.item)}</div>
                  <div class="meta">Qty: <span class="mono">${esc(it.qty ?? 1)}</span> ‚Ä¢ Bag: <strong>${esc(it.luggage||"‚Äî")}</strong></div>
                </div>
                <button class="miniBtn" data-del-pack="${esc(person)}" data-idx="${idx}">Delete</button>
              </div>
            `).join("")
          }
        </div>
      `;
      document.querySelectorAll("[data-pack]").forEach(cb=>{
        cb.onchange = () => {
          const p = cb.dataset.pack;
          const i = Number(cb.dataset.idx);
          state.packing[p][i].packed = cb.checked;
          markDirty(); rerender(false);
        };
      });
      document.querySelectorAll("[data-del-pack]").forEach(btn=>{
        btn.onclick = () => {
          const p = btn.dataset.delPack;
          const i = Number(btn.dataset.idx);
          state.packing[p].splice(i,1);
          markDirty(); rerender(false);
        };
      });
    }

    renderChecklist(current);

    document.querySelectorAll("[data-pack-person]").forEach(btn=>{
      btn.onclick = () => {
        state.__ui.packPerson = btn.dataset.packPerson;
        markDirty(); rerender(false);
      };
    });

    document.getElementById("btnAddPackItem").onclick = () => openPackingModal();
    document.getElementById("btnPackAll").onclick = () => {
      const p = state.__ui.packPerson || people[0];
      if (!p) return;
      for (const it of (state.packing[p]||[])) it.packed = true;
      markDirty(); rerender(false);
    };
  }

  // ---------------------------
  // Render: Polls & Ideas
  // ---------------------------
  function renderIdeas() {
    const people = travellers();
    return `
      <div class="grid">
        <section class="card">
          <div class="hd">
            <h2>Polls</h2>
            <button class="btn primary" id="btnAddPoll">New poll</button>
          </div>
          <div class="bd">
            <div class="list">
              ${
                state.polls.map((p,pi)=>`
                  <div class="sectionBox">
                    <div class="shd">
                      <strong>${esc(p.question)}</strong>
                      <button class="miniBtn" data-del-poll="${pi}">Delete</button>
                    </div>
                    <div class="sbd">
                      ${
                        p.options.map((o,oi)=>{
                          const votes = o.votes || [];
                          const pct = people.length ? Math.round((votes.length/people.length)*100) : 0;
                          return `
                            <div class="note">
                              <div style="flex:1;">
                                <div class="t"><strong>${esc(o.text)}</strong></div>
                                <div class="small">${votes.length} vote${votes.length===1?"":"s"} ‚Ä¢ ${pct}%</div>
                                <div class="bar" style="margin-top:8px"><div style="width:${pct}%"></div></div>
                                <div class="small">${votes.length ? "Voted: " + esc(votes.join(", ")) : "No votes yet."}</div>
                              </div>
                              <div class="actions">
                                <button class="miniBtn" data-vote="${pi}" data-opt="${oi}">Vote</button>
                              </div>
                            </div>
                          `;
                        }).join("")
                      }
                      <button class="btn ghost" data-add-opt="${pi}">Add option</button>
                    </div>
                  </div>
                `).join("")
              }
            </div>
            <div class="hint"></div>
          </div>
        </section>

        <section class="card">
          <div class="hd">
            <h2>Shared links</h2>
            <button class="btn ghost" id="btnAddLink">Add link</button>
          </div>
          <div class="bd">
            <div class="list">
              ${
                state.links.map((l,idx)=>`
                  <div class="todo" style="grid-template-columns: 1fr auto;">
                    <div>
                      <div class="title">${esc(l.label)}</div>
                      <div class="meta"><a href="${esc(l.url||"#")}" target="_blank" rel="noreferrer">${esc(l.url||"‚Äî")}</a></div>
                    </div>
                    <button class="miniBtn" data-del-link="${idx}">Delete</button>
                  </div>
                `).join("")
              }
            </div>
            <div class="hint">Add details and links.</div>
          </div>
        </section>
      </div>
    `;
  }

  function bindIdeas() {
    const people = travellers();

    document.getElementById("btnAddPoll").onclick = () => openPollModal();
    document.getElementById("btnAddLink").onclick = () => openLinkModal();

    document.querySelectorAll("[data-del-poll]").forEach(btn=>{
      btn.onclick = () => {
        const i = Number(btn.dataset.delPoll);
        state.polls.splice(i,1);
        markDirty(); rerender();
      };
    });

    document.querySelectorAll("[data-vote]").forEach(btn=>{
      btn.onclick = () => {
        const pi = Number(btn.dataset.vote);
        const oi = Number(btn.dataset.opt);
        openVoteModal(pi, oi);
      };
    });

    document.querySelectorAll("[data-add-opt]").forEach(btn=>{
      btn.onclick = () => {
        const pi = Number(btn.dataset.addOpt);
        openAddOptionModal(pi);
      };
    });

    document.querySelectorAll("[data-del-link]").forEach(btn=>{
      btn.onclick = () => {
        const i = Number(btn.dataset.delLink);
        state.links.splice(i,1);
        markDirty(); rerender();
      };
    });
  }

  // ---------------------------
  // Render: Settings
  // ---------------------------
  function renderSettings() {
    return `
      <div class="grid">
        <section class="card">
          <div class="hd">
            <h2>Sync & sharing</h2>
            <div class="row">
              <button class="btn ghost" id="btnExport2">Export JSON</button>
              <button class="btn ghost" id="btnImport2">Import JSON</button>
              <button class="btn danger" id="btnReset">Reset</button>
            </div>
          </div>
          <div class="bd">
            <div class="hint">
              Download Excel Summary.
            </div>
          </div>
        </section>

        <section class="card">
          <div class="hd">
            <h2>Trip settings</h2>
            <button class="btn primary" id="btnEditTrip2">Edit</button>
          </div>
          <div class="bd">
            <table class="table">
              <tbody>
                <tr><td><strong>Site title</strong></td><td>${esc(state.trip.siteTitle)}</td></tr>
                <tr><td><strong>Destination</strong></td><td>${esc(state.trip.destination)}</td></tr>
                <tr><td><strong>Dates</strong></td><td class="mono">${esc(tripRangeLabel())}</td></tr>
                <tr><td><strong>Travellers</strong></td><td>${travellers().map(esc).join(", ")}</td></tr>
              </tbody>
            </table>
            <div class="hint">
            </div>
          </div>
        </section>
      </div>
    `;
  }

  function bindSettings() {
    document.getElementById("btnExport2").onclick = () => exportJson();
    document.getElementById("btnImport2").onclick = () => document.getElementById("fileInput").click();
    document.getElementById("btnReset").onclick = () => {
      if (!confirm("Reset everything back to the original Excel import?")) return;
      localStorage.removeItem(STORAGE_KEY);
      state = deepClone(window.__INITIAL_DATA__);
      ensureItineraryShape();
      markDirty();
      rerender();
    };
    document.getElementById("btnEditTrip2").onclick = () => openTripModal();
    document.getElementById("btnImport2").onclick = () => document.getElementById("fileInput").click();
  }

  // ---------------------------
  // Modals (forms)
  // ---------------------------
  function openTodoModal() {
    const people = travellers();
    openModal({
      title: "Add task",
      sub: "Keep it short and assign an owner if you want.",
      bodyHtml: `
        <div class="split">
          <div>
            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Task</div>
            <input class="input" id="todoTitle" placeholder="e.g. Book DMZ tour" />
          </div>
          <div>
            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Owner</div>
            <select id="todoOwner">
              <option value="">Unassigned</option>
              ${
                people.map(p=>`<option>${esc(p)}</option>`).join("")
              }
            </select>
          </div>
        </div>
        <div style="height:10px"></div>
        <div>
          <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Due date (optional)</div>
          <input class="input" id="todoDue" type="date" />
        </div>
        <div style="height:12px"></div>
        <button class="btn primary" id="todoSave">Add task</button>
      `
    });
    document.getElementById("todoSave").onclick = () => {
      const title = document.getElementById("todoTitle").value.trim();
      if (!title) return alert("Task title required.");
      const owner = document.getElementById("todoOwner").value;
      const due = document.getElementById("todoDue").value;
      state.todos.unshift({title, owner, due, done:false});
      markDirty(); closeModal(); rerender();
    };
  }

  function openTripModal() {
    const people = travellers();
    openModal({
      title: "Edit trip",
      sub: "These fields control the whole site.",
      bodyHtml: `
        <div class="split">
          <div>
            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Site title</div>
            <input class="input" id="tripTitle" value="${esc(state.trip.siteTitle)}" />
          </div>
          <div>
            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Destination</div>
            <input class="input" id="tripDest" value="${esc(state.trip.destination)}" />
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="split">
          <div>
            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Start date</div>
            <input class="input" id="tripStart" type="date" value="${esc(state.trip.startDate)}" />
          </div>
          <div>
            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">End date</div>
            <input class="input" id="tripEnd" type="date" value="${esc(state.trip.endDate)}" />
          </div>
        </div>
        <div style="height:10px"></div>
        <div>
          <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Travellers (comma-separated)</div>
          <input class="input" id="tripPeople" value="${esc(travellers().join(", "))}" />
        </div>
        <div style="height:12px"></div>
        <button class="btn primary" id="tripSave">Save</button>
      `
    });
    document.getElementById("tripSave").onclick = () => {
      state.trip.siteTitle = document.getElementById("tripTitle").value.trim() || state.trip.siteTitle;
      state.trip.destination = document.getElementById("tripDest").value.trim() || state.trip.destination;
      const s = document.getElementById("tripStart").value;
      const e = document.getElementById("tripEnd").value;
      if (s) state.trip.startDate = s;
      if (e) state.trip.endDate = e;

      const ppl = document.getElementById("tripPeople").value
        .split(",").map(x=>x.trim()).filter(Boolean);
      if (ppl.length) state.trip.travellers = ppl;

      // rebuild days list from dates (inclusive)
      const start = dayjs(state.trip.startDate);
      const end = dayjs(state.trip.endDate);
      const days = [];
      let cur = start;
      while (cur.isBefore(end) || cur.isSame(end,"day")) {
        days.push(cur.format("YYYY-MM-DD"));
        cur = cur.add(1,"day");
      }
      state.itinerary.days = days;
      ensureItineraryShape();

      // ensure packing keys exist for all travellers
      for (const p of state.trip.travellers) {
        if (!state.packing[p]) state.packing[p] = [];
      }

      markDirty();
      closeModal();
      rerender();
    };
  }

  function openExpenseModal({goToBudget}) {
    const cats = state.budget.categories.map(c=>c.category);
    const people = travellers();
    openModal({
      title: "Add expense",
      sub: "AUD",
      bodyHtml: `
        <div class="split">
          <div>
            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Category</div>
            <select id="exCat">
              ${
                cats.map(c=>`<option>${esc(c)}</option>`).join("")
              }
            </select>
          </div>
          <div>
            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Paid by</div>
            <select id="exBy">
              <option value="">‚Äî</option>
              ${
                people.map(p=>`<option>${esc(p)}</option>`).join("")
              }
            </select>
          </div>
        
          <div>
            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Participants</div>
            <div class="chips" id="exParts">
              ${ people.map(p=>`<span class="chipBtn on" data-part="${esc(p)}">${esc(p)}</span>`).join("") }
            </div>
            <div class="hint" style="margin-top:8px">Toggle who paid.</div>
          </div>
</div>

        <div style="height:10px"></div>

        <div>
          <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Description</div>
          <input class="input" id="exDesc" placeholder="e.g. T-money cards + snacks" />
        </div>

        <div style="height:10px"></div>

        <div class="split">
          <div>
            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">AUD</div>
            <input class="input mono" id="exAud" type="number" step="0.01" placeholder="0.00" />
          </div>
          <div>
            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">KRW (optional)</div>
            <input class="input mono" id="exKrw" type="number" step="1" placeholder="0" />
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="row">
          <label class="row" style="gap:8px;">
            <input type="checkbox" id="exPaid" checked />
            <span class="muted" style="font-size:12px; font-weight:650;">Marked as paid</span>
          </label>
          <input class="input" id="exDate" type="date" style="max-width:210px" />
        </div>

        <div style="height:12px"></div>
        <button class="btn primary" id="exSave">Add expense</button>
      `
    });

    document.querySelectorAll("#exParts .chipBtn").forEach(btn=>{
      btn.onclick = () => {
        btn.classList.toggle("on");
        btn.classList.toggle("off");
      };
    });

    document.getElementById("exSave").onclick = () => {
      const category = document.getElementById("exCat").value;
      const description = document.getElementById("exDesc").value.trim();
      const aud = Number(document.getElementById("exAud").value || 0);
      const krw = Number(document.getElementById("exKrw").value || 0);
      const paidBy = document.getElementById("exBy").value;
      const paid = document.getElementById("exPaid").checked;
      const date = document.getElementById("exDate").value;
      const parts = Array.from(document.querySelectorAll("#exParts .chipBtn.on")).map(el=>el.dataset.part);
      if (!category) return alert("Category required.");
      state.budget.expenses.unshift({
        category, description, currency: "$",
        aud, krw, paid, paidBy, date, participants: parts, notes:""
      });
      // bump category actual
      const cat = state.budget.categories.find(c=>c.category===category);
      if (cat) cat.actual = Number(cat.actual||0) + aud;

      markDirty();
      closeModal();
      if (goToBudget) setHash("budget");
      rerender();
    };
  }

  function openCategoryModal() {
    openModal({
      title: "Add category",
      sub: "Add a new budget bucket.",
      bodyHtml: `
        <div class="split">
          <div>
            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Category name</div>
            <input class="input" id="catName" placeholder="e.g. Caf√©s" />
          </div>
          <div>
            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Estimated (AUD)</div>
            <input class="input mono" id="catEst" type="number" step="0.01" placeholder="0.00" />
          </div>
        </div>
        <div style="height:12px"></div>
        <button class="btn primary" id="catSave">Add</button>
      `
    });
    document.getElementById("catSave").onclick = () => {
      const category = document.getElementById("catName").value.trim();
      const estimated = Number(document.getElementById("catEst").value || 0);
      if (!category) return alert("Category name required.");
      state.budget.categories.push({category, estimated, actual:0});
      markDirty(); closeModal(); rerender();
    };
  }

  function openItineraryItemModal({day, section, idx, prefill}) {
    ensureItineraryShape();
    const people = travellers();
    const sec = section || "Main events";
    const editing = (idx != null);
    const it = editing ? state.itinerary.items[day][sec][idx] : (prefill || {text:"", time:"", place:"", owner:""});
    openModal({
      title: editing ? "Edit itinerary item" : "Add itinerary item",
      sub: `${dayLabel(day)} ‚Ä¢ ${sec}`,
      bodyHtml: `
        <div class="split">
          <div>
            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Section</div>
            <select id="itSec">
              ${
                state.itinerary.sections.map(s=>`<option ${s===sec?"selected":""}>${esc(s)}</option>`).join("")
              }
            </select>
          </div>
          <div>
            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Owner (optional)</div>
            <select id="itOwner">
              <option value="">‚Äî</option>
              ${
                people.map(p=>`<option ${p===it.owner?"selected":""}>${esc(p)}</option>`).join("")
              }
            </select>
          </div>
        </div>

        <div style="height:10px"></div>

        <div>
          <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">What</div>
          <input class="input" id="itText" value="${esc(it.text||"")}" placeholder="e.g. Gyeongbokgung Palace + guard change" />
        </div>

        <div style="height:10px"></div>

        <div class="split">
          <div>
            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Time (optional)</div>
            <input class="input" id="itTime" value="${esc(it.time||"")}" placeholder="e.g. 10:00" />
          </div>
          <div>
            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Place (optional)</div>
            <input class="input" id="itPlace" value="${esc(it.place||"")}" placeholder="e.g. Seoul" />
          </div>
        </div>

        <div style="height:12px"></div>
        <button class="btn primary" id="itSave">${editing?"Save changes":"Add item"}</button>
      `
    });
    document.getElementById("itSave").onclick = () => {
      const newSec = document.getElementById("itSec").value;
      const item = {
        text: document.getElementById("itText").value.trim(),
        time: document.getElementById("itTime").value.trim(),
        place: document.getElementById("itPlace").value.trim(),
        owner: document.getElementById("itOwner").value
      };
      if (!item.text) return alert("Please add a 'What' description.");

      if (editing) {
        // if section changed, move item
        if (newSec !== sec) {
          state.itinerary.items[day][sec].splice(idx,1);
          state.itinerary.items[day][newSec].push(item);
        } else {
          state.itinerary.items[day][sec][idx] = item;
        }
      } else {
        state.itinerary.items[day][newSec].push(item);
      }
      markDirty();
      closeModal();
      rerender();
    };
  }

  function openAddDayModal() {
    openModal({
      title: "Add day",
      sub: "Append a day to the itinerary list.",
      bodyHtml: `
        <div>
          <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Date</div>
          <input class="input" id="newDay" type="date" />
        </div>
        <div style="height:12px"></div>
        <button class="btn primary" id="addDaySave">Add day</button>
      `
    });
    document.getElementById("addDaySave").onclick = () => {
      const d = document.getElementById("newDay").value;
      if (!d) return alert("Pick a date.");
      if (state.itinerary.days.includes(d)) return alert("That day already exists.");
      state.itinerary.days.push(d);
      state.itinerary.days.sort();
      ensureItineraryShape();
      selectedDay = d;
      markDirty(); closeModal(); rerender();
    };
  }

  function openSpotModal() {
    openModal({
      title: "Add spot",
      sub: "Add an attraction / restaurant / market / anything.",
      bodyHtml: `
        <div class="split">
          <div>
            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Name</div>
            <input class="input" id="spotName" placeholder="e.g. Gwangjang Market" />
          </div>
          <div>
            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">City</div>
            <input class="input" id="spotCity" placeholder="e.g. Seoul" />
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="split">
          <div>
            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Opening hours (optional)</div>
            <input class="input" id="spotHours" placeholder="e.g. 10:00‚Äì22:00" />
          </div>
          <div>
            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Fee in won (optional)</div>
            <input class="input mono" id="spotFee" type="number" step="1" placeholder="0" />
          </div>
        </div>
        <div style="height:10px"></div>
        <div>
          <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Notes</div>
          <input class="input" id="spotNotes" placeholder="e.g. Must try bindaetteok" />
        </div>
        <div style="height:12px"></div>
        <button class="btn primary" id="spotSave">Add spot</button>
      `
    });
    document.getElementById("spotSave").onclick = () => {
      const name = document.getElementById("spotName").value.trim();
      if (!name) return alert("Name required.");
      const city = document.getElementById("spotCity").value.trim();
      const hours = document.getElementById("spotHours").value.trim();
      const feeWon = Number(document.getElementById("spotFee").value || 0);
      const notes = document.getElementById("spotNotes").value.trim();
      state.attractions.unshift({name, city, hours, feeWon, notes, saved:false, tags:[], address:""});
      markDirty(); closeModal(); rerender();
    };
  }

  function openPackingModal() {
    const people = travellers();
    state.__ui = state.__ui || {};
    const current = state.__ui.packPerson || people[0] || "";
    openModal({
      title: "Add packing item",
      sub: "Add an item to someone‚Äôs list.",
      bodyHtml: `
        <div class="split">
          <div>
            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Person</div>
            <select id="pkPerson">
              ${
                people.map(p=>`<option ${p===current?"selected":""}>${esc(p)}</option>`).join("")
              }
            </select>
          </div>
          <div>
            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Qty</div>
            <input class="input mono" id="pkQty" type="number" step="1" value="1" />
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="split">
          <div>
            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Item</div>
            <input class="input" id="pkItem" placeholder="e.g. Portable charger" />
          </div>
          <div>
            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Bag (optional)</div>
            <input class="input" id="pkBag" placeholder="e.g. Carry-on" />
          </div>
        </div>
        <div style="height:12px"></div>
        <button class="btn primary" id="pkSave">Add</button>
      `
    });
    document.getElementById("pkSave").onclick = () => {
      const person = document.getElementById("pkPerson").value;
      const item = document.getElementById("pkItem").value.trim();
      const luggage = document.getElementById("pkBag").value.trim();
      const qty = Number(document.getElementById("pkQty").value || 1);
      if (!person || !item) return alert("Person and item required.");
      state.packing[person] = state.packing[person] || [];
      state.packing[person].unshift({item, luggage, qty, packed:false});
      state.__ui.packPerson = person;
      markDirty(); closeModal(); rerender(false);
    };
  }

  function openPollModal() {
    openModal({
      title: "New poll",
      sub: "Ask the group to choose (food, day trips, hotels‚Ä¶).",
      bodyHtml: `
        <div>
          <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Question</div>
          <input class="input" id="pollQ" placeholder="e.g. Which day trip?" />
        </div>
        <div style="height:10px"></div>
        <div class="split">
          <div><input class="input" id="pollO1" placeholder="Option 1" /></div>
          <div><input class="input" id="pollO2" placeholder="Option 2" /></div>
        </div>
        <div style="height:12px"></div>
        <button class="btn primary" id="pollSave">Create poll</button>
      `
    });
    document.getElementById("pollSave").onclick = () => {
      const q = document.getElementById("pollQ").value.trim();
      const o1 = document.getElementById("pollO1").value.trim();
      const o2 = document.getElementById("pollO2").value.trim();
      if (!q || !o1) return alert("Need a question + at least one option.");
      const options = [o1,o2].filter(Boolean).map(t=>({text:t, votes:[]}));
      state.polls.unshift({question:q, options});
      markDirty(); closeModal(); rerender();
    };
  }

  function openVoteModal(pi, oi) {
    const people = travellers();
    const poll = state.polls[pi];
    const opt = poll.options[oi];
    openModal({
      title: "Vote",
      sub: poll.question,
      bodyHtml: `
        <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Choose your name</div>
        <select id="voteName">
          ${
            people.map(p=>`<option>${esc(p)}</option>`).join("")
          }
        </select>
        <div style="height:10px"></div>
        <div class="hint">Voting toggles: if you already voted for this option, voting again removes your vote.</div>
        <div style="height:12px"></div>
        <button class="btn primary" id="voteSave">Vote for ‚Äú${esc(opt.text)}‚Äù</button>
      `
    });
    document.getElementById("voteSave").onclick = () => {
      const name = document.getElementById("voteName").value;
      // Remove from all options first (one vote per poll)
      for (const o of poll.options) {
        o.votes = (o.votes||[]).filter(v=>v!==name);
      }
      // Toggle on selected option
      const cur = opt.votes || [];
      if (!cur.includes(name)) cur.push(name);
      opt.votes = cur;
      markDirty(); closeModal(); rerender(false);
    };
  }

  function openAddOptionModal(pi) {
    openModal({
      title: "Add option",
      sub: "Add another choice to the poll.",
      bodyHtml: `
        <div>
          <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Option text</div>
          <input class="input" id="optText" placeholder="e.g. Lotte World" />
        </div>
        <div style="height:12px"></div>
        <button class="btn primary" id="optSave">Add</button>
      `
    });
    document.getElementById("optSave").onclick = () => {
      const t = document.getElementById("optText").value.trim();
      if (!t) return alert("Option text required.");
      state.polls[pi].options.push({text:t, votes:[]});
      markDirty(); closeModal(); rerender(false);
    };
  }

  function openLinkModal() {
    openModal({
      title: "Add link",
      sub: "Paste in anything useful for the group.",
      bodyHtml: `
        <div class="split">
          <div>
            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">Label</div>
            <input class="input" id="linkLabel" placeholder="e.g. Shared Google Map" />
          </div>
          <div>
            <div class="muted" style="font-size:12px; font-weight:650; margin-bottom:6px;">URL</div>
            <input class="input" id="linkUrl" placeholder="https://‚Ä¶" />
          </div>
        </div>
        <div style="height:12px"></div>
        <button class="btn primary" id="linkSave">Add</button>
      `
    });
    document.getElementById("linkSave").onclick = () => {
      const label = document.getElementById("linkLabel").value.trim();
      const url = document.getElementById("linkUrl").value.trim();
      if (!label) return alert("Label required.");
      state.links.unshift({label, url});
      markDirty(); closeModal(); rerender(false);
    };
  }

  // Quick add menu
  function openQuickAdd() {
    openModal({
      title: "Quick add",
      sub: "Pick what you want to add.",
      bodyHtml: `
        <div class="split">
          <button class="btn primary" id="qaIt">Add itinerary item</button>
          <button class="btn primary" id="qaEx">Log expense</button>
          <button class="btn primary" id="qaTodo">Add task</button>
          <button class="btn primary" id="qaSpot">Add attraction</button>
        </div>
        <div style="height:10px"></div>
        <div class="hint">Shortcut: press <span class="kbd">/</span> anywhere to open Quick add.</div>
      `
    });
    document.getElementById("qaIt").onclick = () => { closeModal(); openItineraryItemModal({day:selectedDay}); };
    document.getElementById("qaEx").onclick = () => { closeModal(); openExpenseModal({goToBudget:false}); };
    document.getElementById("qaTodo").onclick = () => { closeModal(); openTodoModal(); };
    document.getElementById("qaSpot").onclick = () => { closeModal(); openSpotModal(); };
  }

  // ---------------------------
  // Export / Import
  // ---------------------------
  function exportJson() {
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "churros-take-south-korea.json";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function importJsonFromFile(file) {
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const obj = JSON.parse(reader.result);
        state = Object.assign(deepClone(window.__INITIAL_DATA__), obj);
        ensureItineraryShape();
        markDirty();
        rerender();
      } catch(e) {
        alert("Invalid JSON file.");
      }
    };
    reader.readAsText(file);
  }

  // ---------------------------
  // Main render loop
  // ---------------------------
  function rerender(full=true) {
    // header
    document.getElementById("brandTitle").textContent = state.trip.siteTitle || "Churros take South Korea";
    document.getElementById("tripLine").textContent = state.trip.destination || "South Korea";
    document.getElementById("dateLine").textContent = tripRangeLabel();

    renderNav();

    const page = currentPage();
    if (page === "overview") {
      viewEl.innerHTML = renderOverview();
      bindOverview();
    } else if (page === "itinerary") {
      viewEl.innerHTML = renderItinerary();
      bindItinerary();
    } else if (page === "budget") {
      viewEl.innerHTML = renderBudget();
      bindBudget();
    } else if (page === "attractions") {
      viewEl.innerHTML = renderAttractions();
      bindAttractions();
    } else if (page === "packing") {
      viewEl.innerHTML = renderPacking();
      bindPacking();
    } else if (page === "ideas") {
      viewEl.innerHTML = renderIdeas();
      bindIdeas();
    } else if (page === "settings") {
      viewEl.innerHTML = renderSettings();
      bindSettings();
    }
  }

  window.addEventListener("hashchange", () => rerender());

  // Top buttons
  document.getElementById("btnExport").onclick = () => exportJson();
  document.getElementById("btnImport").onclick = () => document.getElementById("fileInput").click();
  document.getElementById("btnQuickAdd").onclick = () => openQuickAdd();

  document.getElementById("fileInput").addEventListener("change", (e)=>{
    const file = e.target.files?.[0];
    if (file) importJsonFromFile(file);
    e.target.value = "";
  });

  // Keyboard shortcuts
  window.addEventListener("keydown", (e)=>{
    if (e.key === "/" && !["INPUT","TEXTAREA","SELECT"].includes(document.activeElement?.tagName)) {
      e.preventDefault();
      openQuickAdd();
    }
    if (e.key === "Escape") closeModal();
  });

  // Initial render
  rerender();

  </script>
</body>
</html>


